<html>
  <head>
    <title>wired</title>
    <link rel="stylesheet" href="style/style.css">
  </head>
  <body>
    <div class="header container">
      <h1>【wired-world】</h1>
      <p>
        source code: <a href="https://github.com/eva-native/wired-world">github</a>
      </p>
    </div>
    <div class="nav"></div>
    <div class="content container">
      <div class="guest-book">
        <div id="posts" hx-get="/post" hx-trigger="load, every 3s"> </div>
        <form id="messageForm"
              hx-post="/post"
              hx-target="#posts"
              hx-swap="beforeend"
              hx-on::after-request="if(event.detail.successful) this.reset()">
          <textarea rows="10"
                    name="message"
                    id="messageArea"></textarea>
          <button id="submitButton" type="submit">MARK</button>
          <p>
            message size: <span id="messageSize" class="message-size">0x00 bytes</span>
          </p>
          <span>max message size <span class="message-size">0x80</span> bytes</span>
        </form>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.6/dist/htmx.min.js"
      integrity="sha384-Akqfrbj/HpNVo8k11SXBb6TlBWmXXlYQrCSqEWmyKJe+hDm3Z/B2WVG4smwBkRVm"
      crossorigin="anonymous"
    ></script>
    <script>
      var maxMessageSize = 0x80
      var elem = id => document.querySelector(id)
      var sizeInBytes = s => textEncoder.encode(s).length
      var renderMessageSize =
        s => `0x${s.toString(16).toUpperCase().padStart(2, "0")} bytes` +
             (s > maxMessageSize ? ` (message is big)` : "")

      var messageForm = elem("#messageForm")
      var messageArea = elem("#messageArea")
      var messageSize = elem("#messageSize")
      var textEncoder = new TextEncoder()

      messageForm.addEventListener("htmx:beforeRequest", e => {
        if (messageArea.value.length === 0 ||
          sizeInBytes(messageArea.value) > maxMessageSize) {
          e.preventDefault()
          return
        }
      })
      messageArea.addEventListener("keypress", e => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.target.form.dispatchEvent(new Event("submit", {cancelable: true}))
          e.preventDefault()
        }
      })
      messageArea.addEventListener("keyup", e => {
        let size = sizeInBytes(messageArea.value)
        messageSize.innerHTML = renderMessageSize(size)
      })
    </script>
  </body>
</html>
