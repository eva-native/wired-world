<html>
  <head>
    <title>wired</title>
  </head>
  <body>
    <div class="header">
      <h1>【wired-world】</h1>
    </div>
    <div class="nav"></div>
    <div class="content">
      <div id="posts" hx-get="/post" hx-trigger="load, every 3s"> </div>
      <form id="messageForm"
            hx-post="/post"
            hx-target="#posts"
            hx-swap="beforeend"
            hx-on::after-request="if(event.detail.successful) this.reset()">
        <textarea cols="40"
                  rows="10"
                  name="message"
                  id="messageArea"></textarea>
        <button id="submitButton" type="submit">MARK</button>
        <p>
          message size: <span id="messageSize">0x00 bytes</span>
        </p>
      </form>
      <span>max message size 0x80 bytes</span>
    </div>
    <div class="footer">
      <p>
        source code: <a href="https://github.com/eva-native/wired-world">github</a>
      </p>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.6/dist/htmx.min.js"
      integrity="sha384-Akqfrbj/HpNVo8k11SXBb6TlBWmXXlYQrCSqEWmyKJe+hDm3Z/B2WVG4smwBkRVm"
      crossorigin="anonymous"
    ></script>
    <script>
      var maxMessageSize = 0x80
      var elem = id => document.querySelector(id)
      var sizeInBytes = s => textEncoder.encode(s).length
      var renderMessageSize =
        s => `0x${s.toString(16).toUpperCase().padStart(2, "0")} bytes` +
             (s > maxMessageSize ? ` (message is big)` : "")

      var messageForm = elem("#messageForm")
      var messageArea = elem("#messageArea")
      var messageSize = elem("#messageSize")
      var textEncoder = new TextEncoder()

      messageForm.addEventListener("htmx:beforeRequest", e => {
        if (messageArea.value.length === 0 ||
          sizeInBytes(messageArea.value) >= maxMessageSize) {
          e.preventDefault()
          return
        }
      })
      messageArea.addEventListener("keypress", e => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.target.form.dispatchEvent(new Event("submit", {cancelable: true}))
          e.preventDefault()
        }
      })
      messageArea.addEventListener("keyup", e => {
        let size = sizeInBytes(messageArea.value)
        messageSize.innerHTML = renderMessageSize(size)
      })
    </script>
  </body>
</html>
